<!-- 
WEBFLOW LOGIN PAGE CODE - MEMBERSTACK PASSWORDLESS (CODE-BASED)
Add this code to your Webflow login page Footer Code section
This uses Memberstack's passwordless API that sends a CODE to email (not magic link)
-->

<!-- Add this HTML to your login page -->
<form id="passwordlessForm" style="max-width: 500px; margin: 50px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
  <div style="text-align: center; margin-bottom: 30px;">
    <div style="font-size: 48px; margin-bottom: 15px;">üîê</div>
    <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">Login with Email</h2>
    <p style="color: #666; font-size: 14px; margin: 0;">Enter your email to receive a login code</p>
  </div>
  <input 
    type="email" 
    id="passwordlessEmail" 
    placeholder="your@email.com" 
    required
    style="
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 16px;
      margin-bottom: 15px;
      box-sizing: border-box;
    "
  />
  <button 
    type="submit" 
    id="passwordlessButton"
    style="
      width: 100%;
      padding: 14px 24px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    "
  >Send Login Code</button>
  <div id="passwordlessMessage" style="margin-top: 15px; padding: 12px; border-radius: 6px; font-size: 14px; text-align: center;"></div>
  <div id="passwordlessError" style="display: none; color: #f44336; margin-top: 15px; padding: 12px; background: #ffebee; border-radius: 6px; font-size: 14px; text-align: center;"></div>
  
  <!-- Code Input Section (hidden initially) -->
  <div id="codeInputSection" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
    <p style="color: #666; font-size: 14px; margin-bottom: 15px; text-align: center;">Enter the code you received in your email</p>
    <input 
      type="text" 
      id="passwordlessCode" 
      placeholder="Enter 6-digit code" 
      maxlength="6"
      style="
        width: 100%;
        padding: 14px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 18px;
        margin-bottom: 15px;
        box-sizing: border-box;
        text-align: center;
        letter-spacing: 8px;
        font-weight: 600;
      "
    />
    <button 
      type="button" 
      id="verifyCodeButton"
      style="
        width: 100%;
        padding: 14px 24px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s;
      "
    >Verify Code</button>
    <button 
      type="button" 
      id="resendCodeButton"
      style="
        width: 100%;
        padding: 10px 24px;
        background: transparent;
        color: #2196F3;
        border: 1px solid #2196F3;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        margin-top: 10px;
      "
    >Resend Code</button>
  </div>
</form>

<script>
(function() {
    'use strict';
    
    // Get email from URL parameter (for pre-filling)
    function getEmailFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('email');
    }
    
    // Function to get Memberstack SDK
    function getMemberstackSDK() {
        // Check if SDK is ready first
        if (window.$memberstackReady === true) {
            if (window.memberstack) return window.memberstack;
            if (window.$memberstack) return window.$memberstack;
            if (window.Memberstack) return window.Memberstack;
            if (window.$memberstackDom && window.$memberstackDom.memberstack) return window.$memberstackDom.memberstack;
            if (window.$memberstackDom) return window.$memberstackDom;
        }
        // Fallback: try without ready check
        return window.memberstack || 
               window.$memberstack || 
               window.Memberstack ||
               (window.$memberstackDom && window.$memberstackDom.memberstack) ||
               window.$memberstackDom ||
               null;
    }
    
    // Wait for Memberstack SDK to load
    async function waitForSDK() {
        let attempts = 0;
        const maxAttempts = 40; // 20 seconds
        
        while (attempts < maxAttempts) {
            const memberstack = getMemberstackSDK();
            if (memberstack || window.$memberstackReady === true) {
                return getMemberstackSDK();
            }
            await new Promise(resolve => setTimeout(resolve, 500));
            attempts++;
        }
        return null;
    }
    
    // Initialize passwordless form
    async function initializePasswordlessForm() {
        // Wait for SDK
        const memberstack = await waitForSDK();
        
        if (!memberstack) {
            console.error('[Webflow Login] Memberstack SDK not loaded');
            document.getElementById('passwordlessError').textContent = 'Authentication system not loaded. Please refresh the page.';
            document.getElementById('passwordlessError').style.display = 'block';
            return;
        }
        
        
        // Pre-fill email from URL if present
        const emailFromUrl = getEmailFromURL();
        if (emailFromUrl) {
            document.getElementById('passwordlessEmail').value = emailFromUrl;
        }
        
        let isEmailSent = false;
        const form = document.getElementById('passwordlessForm');
        const button = document.getElementById('passwordlessButton');
        const messageDiv = document.getElementById('passwordlessMessage');
        const errorDiv = document.getElementById('passwordlessError');
        
        // Get dashboard URL from environment or use default
        const dashboardUrl = window.location.origin + '/dashboard';
        
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            if (isEmailSent) {
                return; // Prevent multiple sends
            }
            
            button.disabled = true;
            button.textContent = 'Sending...';
            errorDiv.style.display = 'none';
            messageDiv.textContent = '';
            messageDiv.style.background = '';
            messageDiv.style.color = '';
            
            // Normalize email (lowercase, trim) to ensure consistency with Memberstack
            const emailInput = document.getElementById('passwordlessEmail');
            let email = emailInput.value.trim();
            
            if (!email) {
                errorDiv.textContent = 'Please enter your email address';
                errorDiv.style.display = 'block';
                button.disabled = false;
                button.textContent = 'Send Login Code';
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorDiv.textContent = 'Please enter a valid email address';
                errorDiv.style.display = 'block';
                button.disabled = false;
                button.textContent = 'Send Login Code';
                return;
            }
            
            // Normalize email to lowercase (Memberstack stores emails in lowercase)
            email = email.toLowerCase().trim();
            
            // Update input field with normalized email (so user sees what was sent)
            emailInput.value = email;
            
            console.log('[Webflow Login] Sending passwordless code to:', email);
            
            try {
                
                // Use Memberstack's passwordless API
                // IMPORTANT: Use normalized email to match Memberstack storage
                const response = await memberstack.sendMemberLoginPasswordlessEmail({
                    email: email,
                    redirectUrl: dashboardUrl
                });
                
                console.log('[Webflow Login] ‚úÖ Passwordless email sent successfully:', response);
                
                isEmailSent = true;
                messageDiv.textContent = '‚úÖ Check your email for the login code';
                messageDiv.style.background = '#e8f5e9';
                messageDiv.style.color = '#2e7d32';
                messageDiv.style.display = 'block';
                button.textContent = 'Code Sent - Check Email';
                button.style.background = '#4caf50';
                
                // Show code input section
                document.getElementById('codeInputSection').style.display = 'block';
                document.getElementById('passwordlessCode').focus();
                
                
                // Reset after 60 seconds
                setTimeout(() => {
                    isEmailSent = false;
                    button.disabled = false;
                    button.textContent = 'Send Login Code';
                    button.style.background = '#2196F3';
                    messageDiv.textContent = '';
                    messageDiv.style.display = 'none';
                }, 60000);
            } catch (error) {
                console.error('[Webflow Login] ‚ùå Error sending passwordless email:', error);
                console.error('[Webflow Login] Error details:', {
                    message: error.message,
                    stack: error.stack,
                    email: email
                });
                
                // Provide more specific error messages
                let errorMessage = "Couldn't send login code. Please try again.";
                if (error.message) {
                    const errorMsgLower = error.message.toLowerCase();
                    if (errorMsgLower.includes('not found') || errorMsgLower.includes('does not exist') || errorMsgLower.includes('member not found')) {
                        errorMessage = 'Account not found. Please sign up first or contact support.';
                    } else if (errorMsgLower.includes('rate limit') || errorMsgLower.includes('too many')) {
                        errorMessage = 'Too many requests. Please wait a moment and try again.';
                    } else if (errorMsgLower.includes('invalid email')) {
                        errorMessage = 'Invalid email address. Please check and try again.';
                    } else {
                        errorMessage = error.message || errorMessage;
                    }
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
                button.disabled = false;
                button.textContent = 'Send Login Code';
            }
        });
        
        // Code verification handler
        const verifyCodeButton = document.getElementById('verifyCodeButton');
        const codeInput = document.getElementById('passwordlessCode');
        const resendCodeButton = document.getElementById('resendCodeButton');
        
        verifyCodeButton.addEventListener('click', async () => {
            const code = codeInput.value.trim();
            
            if (!code) {
                errorDiv.textContent = 'Please enter the code';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Validate code format (should be 6 digits)
            if (code.length !== 6 || !/^\d+$/.test(code)) {
                errorDiv.textContent = 'Please enter a valid 6-digit code';
                errorDiv.style.display = 'block';
                return;
            }
            
            verifyCodeButton.disabled = true;
            verifyCodeButton.textContent = 'Verifying...';
            errorDiv.style.display = 'none';
            
            // Normalize email (lowercase, trim) to match Memberstack storage
            const emailInput = document.getElementById('passwordlessEmail');
            const email = emailInput.value.trim().toLowerCase();
            
            console.log('[Webflow Login] Verifying code for email:', email);
            console.log('[Webflow Login] Code length:', code.length);
            
            try {
                // Method 1: Try with email and code (most common)
                let member = null;
                let verificationError = null;
                
                try {
                    console.log('[Webflow Login] Attempting loginMemberPasswordless with email and code...');
                    member = await memberstack.loginMemberPasswordless({
                        passwordlessToken: code,
                        email: email
                    });
                    console.log('[Webflow Login] ‚úÖ Verification successful with email');
                } catch (error1) {
                    console.warn('[Webflow Login] Method 1 failed:', error1.message);
                    verificationError = error1;
                    
                    // Method 2: Try with just the code (some Memberstack versions don't need email)
                    try {
                        console.log('[Webflow Login] Attempting loginMemberPasswordless with code only...');
                        member = await memberstack.loginMemberPasswordless({
                            passwordlessToken: code
                        });
                        console.log('[Webflow Login] ‚úÖ Verification successful without email');
                    } catch (error2) {
                        console.warn('[Webflow Login] Method 2 failed:', error2.message);
                        verificationError = error2;
                        
                        // Method 3: Try alternative method name (some SDK versions)
                        try {
                            if (memberstack.verifyPasswordlessCode && typeof memberstack.verifyPasswordlessCode === 'function') {
                                console.log('[Webflow Login] Attempting verifyPasswordlessCode...');
                                member = await memberstack.verifyPasswordlessCode({
                                    token: code,
                                    email: email
                                });
                                console.log('[Webflow Login] ‚úÖ Verification successful with verifyPasswordlessCode');
                            } else {
                                throw new Error('No alternative verification method available');
                            }
                        } catch (error3) {
                            console.error('[Webflow Login] All verification methods failed');
                            throw verificationError || error3;
                        }
                    }
                }
                
                // Check if member was returned
                if (!member) {
                    throw new Error('Verification succeeded but no member data returned');
                }
                
                console.log('[Webflow Login] ‚úÖ Member verified:', member);
                
                // Verify we can extract email from member
                const memberEmail = member.email || member._email || (member.data && (member.data.email || member.data.auth?.email)) || email;
                console.log('[Webflow Login] Member email:', memberEmail);
                
                messageDiv.textContent = '‚úÖ Login successful! Redirecting...';
                messageDiv.style.background = '#e8f5e9';
                messageDiv.style.color = '#2e7d32';
                
                // Wait a moment for session to be established
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Redirect to dashboard
                window.location.href = dashboardUrl;
                
            } catch (error) {
                console.error('[Webflow Login] ‚ùå Code verification failed:', error);
                console.error('[Webflow Login] Error details:', {
                    message: error.message,
                    stack: error.stack,
                    email: email,
                    codeLength: code.length
                });
                
                // Provide more specific error messages
                let errorMessage = 'Invalid code. Please try again.';
                if (error.message) {
                    const errorMsgLower = error.message.toLowerCase();
                    if (errorMsgLower.includes('expired') || errorMsgLower.includes('timeout')) {
                        errorMessage = 'Code has expired. Please request a new code.';
                    } else if (errorMsgLower.includes('invalid') || errorMsgLower.includes('incorrect')) {
                        errorMessage = 'Invalid code. Please check and try again.';
                    } else if (errorMsgLower.includes('not found') || errorMsgLower.includes('does not exist')) {
                        errorMessage = 'Account not found. Please sign up first.';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
                codeInput.value = '';
                codeInput.focus();
                verifyCodeButton.disabled = false;
                verifyCodeButton.textContent = 'Verify Code';
            }
        });
        
        // Resend code handler
        resendCodeButton.addEventListener('click', async () => {
            // Normalize email (lowercase, trim) to ensure consistency
            const emailInput = document.getElementById('passwordlessEmail');
            let email = emailInput.value.trim().toLowerCase();
            
            if (!email) {
                errorDiv.textContent = 'Email is required';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Update input field with normalized email
            emailInput.value = email;
            
            resendCodeButton.disabled = true;
            resendCodeButton.textContent = 'Resending...';
            errorDiv.style.display = 'none';
            
            console.log('[Webflow Login] Resending passwordless code to:', email);
            
            try {
                // IMPORTANT: Use normalized email to match Memberstack storage
                await memberstack.sendMemberLoginPasswordlessEmail({
                    email: email,
                    redirectUrl: dashboardUrl
                });
                
                messageDiv.textContent = '‚úÖ New code sent! Check your email.';
                messageDiv.style.background = '#e8f5e9';
                messageDiv.style.color = '#2e7d32';
                codeInput.value = '';
                codeInput.focus();
                
            } catch (error) {
                console.error('[Webflow Login] Error resending code:', error);
                errorDiv.textContent = error.message || "Couldn't resend code. Please try again.";
                errorDiv.style.display = 'block';
            } finally {
                resendCodeButton.disabled = false;
                resendCodeButton.textContent = 'Resend Code';
            }
        });
        
        // Allow Enter key to submit code
        codeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyCodeButton.click();
            }
        });
        
    }
    
    // Handle passwordless verification (if token is in URL)
    async function handlePasswordlessVerification() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || urlParams.get('passwordlessToken');
        
        if (token) {
            const memberstack = await waitForSDK();
            
            if (memberstack) {
                try {
                    const member = await memberstack.loginMemberPasswordless({
                        passwordlessToken: token
                    });
                    
                    // Redirect to dashboard
                    const dashboardUrl = window.location.origin + '/dashboard';
                    window.location.href = dashboardUrl;
                } catch (error) {
                    console.error('[Webflow Login] Passwordless verification failed:', error);
                    document.getElementById('passwordlessError').textContent = 'Invalid or expired login code. Please request a new one.';
                    document.getElementById('passwordlessError').style.display = 'block';
                }
            }
        }
    }
    
    // Initialize when page loads
    function initialize() {
        // Check if Memberstack script tag exists
        const scriptTag = document.querySelector('script[data-memberstack-app]');
        if (!scriptTag) {
            console.warn('[Webflow Login] ‚ö†Ô∏è Memberstack script tag not found!');
            console.warn('[Webflow Login] Please add Memberstack SDK to page HEAD section');
        } else {
        }
        
        // Initialize form
        initializePasswordlessForm();
        
        // Check for verification token
        handlePasswordlessVerification();
    }
    
    // Initialize when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
})();
</script>
