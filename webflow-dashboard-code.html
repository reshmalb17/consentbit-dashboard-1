<!-- 
WEBFLOW DASHBOARD CODE - MEMBERSTACK INTEGRATION
Add this code to your Webflow dashboard page Footer Code section

‚ö†Ô∏è REQUIRED:
1. Memberstack SDK must be in HEAD section
2. All elements must have the IDs specified in WEBFLOW_DASHBOARD_SETUP.md
3. API endpoint must be configured

‚úÖ NO MAGIC LINK CODE - Uses Memberstack native authentication only
-->

<script>
(function() {
    'use strict';
    
    const API_BASE = 'https://consentbit-dashboard-test.web-8fb.workers.dev';
    
    // Function to get Memberstack SDK
    function getMemberstackSDK() {
        if (window.$memberstackReady === true) {
            if (window.memberstack) return window.memberstack;
            if (window.$memberstack) return window.$memberstack;
            if (window.Memberstack) return window.Memberstack;
            if (window.$memberstackDom && window.$memberstackDom.memberstack) return window.$memberstackDom.memberstack;
            if (window.$memberstackDom) return window.$memberstackDom;
        }
        return window.memberstack || 
               window.$memberstack || 
               window.Memberstack ||
               (window.$memberstackDom && window.$memberstackDom.memberstack) ||
               window.$memberstackDom ||
               null;
    }
    
    // Wait for Memberstack SDK
    async function waitForSDK() {
        let attempts = 0;
        const maxAttempts = 40;
        
        while (attempts < maxAttempts) {
            const memberstack = getMemberstackSDK();
            if (memberstack || window.$memberstackReady === true) {
                return getMemberstackSDK();
            }
            await new Promise(resolve => setTimeout(resolve, 500));
            attempts++;
        }
        return null;
    }
    
    // Check if user is logged in
    async function checkMemberstackSession() {
        try {
            const memberstack = await waitForSDK();
            
            if (!memberstack) {
                console.error('[Dashboard] Memberstack SDK not loaded');
                return null;
            }
            
            // Wait for SDK to be ready
            if (memberstack.onReady && typeof memberstack.onReady.then === 'function') {
                await memberstack.onReady;
            }
            
            // Get current member
            if (memberstack.getCurrentMember && typeof memberstack.getCurrentMember === 'function') {
                const member = await memberstack.getCurrentMember();
                if (member && member.id) {
                    return member;
                }
            }
            
            return null;
        } catch (error) {
            console.error('[Dashboard] Error checking session:', error);
            return null;
        }
    }
    
    // Show/hide dashboard content based on login status
    function toggleDashboardVisibility(isLoggedIn) {
        const dashboardElements = document.querySelectorAll('[id^="sites"], [id^="licenses"], [id^="add-site"], #logout-button');
        const loginPrompt = document.getElementById('login-prompt');
        
        dashboardElements.forEach(el => {
            if (el) {
                el.style.display = isLoggedIn ? '' : 'none';
            }
        });
        
        // Show login prompt if not logged in
        if (loginPrompt) {
            loginPrompt.style.display = isLoggedIn ? 'none' : 'block';
        }
        
        // Hide entire dashboard container if not logged in
        const dashboardContainer = document.querySelector('.dashboard-container, [class*="dashboard"]');
        if (dashboardContainer) {
            dashboardContainer.style.display = isLoggedIn ? '' : 'none';
        }
    }
    
    // Show error message
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        console.error('[Dashboard] Error:', message);
    }
    
    // Show success message
    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        if (successDiv) {
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }
    }
    
    // Get or create session token from Memberstack
    async function getSessionToken(memberstack, userEmail) {
        // Try to get existing session token from Memberstack
        // If Memberstack provides a token, use it
        // Otherwise, we'll need to create one via API
        
        try {
            // Check if Memberstack has a token method
            if (memberstack.getToken) {
                const token = await memberstack.getToken();
                if (token) return token;
            }
            
            // If no token, try to get one from API using email
            // This requires API endpoint to support email-based token creation
            const response = await fetch(`${API_BASE}/create-session?email=${encodeURIComponent(userEmail)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.token) {
                    // Set cookie for future requests
                    document.cookie = `sb_session=${data.token}; path=/; max-age=86400; SameSite=Lax`;
                    return data.token;
                }
            }
        } catch (error) {
            console.warn('[Dashboard] Could not get session token:', error);
        }
        
        return null;
    }
    
    // Load dashboard data
    async function loadDashboard(userEmail, memberstack) {
        const sitesContainer = document.getElementById('sites-container');
        if (!sitesContainer) {
            console.error('[Dashboard] Sites container not found');
            return;
        }
        
        sitesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading sites...</div>';
        
        try {
            // First, try to get/create session token
            let sessionToken = await getSessionToken(memberstack, userEmail);
            
            // Try email-based endpoint first (if API supports it)
            let response = await fetch(`${API_BASE}/dashboard?email=${encodeURIComponent(userEmail)}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            
            // If email endpoint doesn't work, try with session cookie
            if (!response.ok && response.status === 401) {
                
                // Get session token if we don't have one
                if (!sessionToken) {
                    sessionToken = await getSessionToken(memberstack, userEmail);
                }
                
                // Try with session cookie
                response = await fetch(`${API_BASE}/dashboard`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
            }
            
            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('Not authenticated');
                }
                throw new Error('Failed to load dashboard');
            }
            
            const data = await response.json();
            displaySites(data.sites || {});
        } catch (error) {
            console.error('[Dashboard] Error loading dashboard:', error);
            sitesContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #f44336;">
                    Failed to load dashboard data. Please refresh the page.
                </div>
            `;
        }
    }
    
    // Display sites
    function displaySites(sites) {
        const container = document.getElementById('sites-container');
        if (!container) return;
        
        if (Object.keys(sites).length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999; grid-column: 1 / -1;">
                    <p style="font-size: 18px; margin-bottom: 10px;">No sites yet</p>
                    <p style="font-size: 14px;">Add your first site above!</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = Object.keys(sites).map(site => {
            const siteData = sites[site];
            const isActive = siteData.status === 'active';
            const statusClass = isActive ? 'active' : 'inactive';
            const statusBadgeClass = isActive ? 'status-active' : 'status-inactive';
            const statusText = isActive ? 'Active' : 'Inactive';
            
            return `
                <div class="site-card ${statusClass}" style="
                    border: 2px solid ${isActive ? '#4caf50' : '#f44336'};
                    border-radius: 8px;
                    padding: 20px;
                    background: ${isActive ? '#f1f8f4' : '#fff5f5'};
                    opacity: ${isActive ? '1' : '0.7'};
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-weight: bold; font-size: 18px; color: #333;">${site}</div>
                        <span style="
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: bold;
                            text-transform: uppercase;
                            background: ${isActive ? '#4caf50' : '#f44336'};
                            color: white;
                        ">${statusText}</span>
                    </div>
                    <div style="color: #666; font-size: 14px; margin: 10px 0;">
                        <div>Item ID: ${siteData.item_id || 'N/A'}</div>
                        <div>Quantity: ${siteData.quantity || 1}</div>
                        ${siteData.created_at ? `<div>Created: ${new Date(siteData.created_at * 1000).toLocaleDateString()}</div>` : ''}
                    </div>
                    ${isActive ? `
                        <button class="remove-site-button" data-site="${site}" style="
                            padding: 10px 20px;
                            background: #f44336;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            margin-top: 10px;
                            width: 100%;
                        ">Remove Site</button>
                    ` : '<p style="color: #999; font-size: 12px; margin-top: 10px;">This site has been removed</p>'}
                </div>
            `;
        }).join('');
        
        // Attach event listeners to remove buttons
        container.querySelectorAll('.remove-site-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const site = btn.getAttribute('data-site');
                removeSite(site);
            });
        });
    }
    
    // Add a new site
    async function addSite(userEmail) {
        const siteInput = document.getElementById('new-site-input');
        const priceInput = document.getElementById('new-site-price');
        
        if (!siteInput || !priceInput) {
            showError('Form elements not found');
            return;
        }
        
        const site = siteInput.value.trim();
        const price = priceInput.value.trim();
        
        if (!site || !price) {
            showError('Please enter both site domain and price ID');
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE}/add-site`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ 
                    site, 
                    price,
                    email: userEmail 
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to add site');
            }
            
            showSuccess('Site added successfully! Billing will be updated on next invoice.');
            siteInput.value = '';
            priceInput.value = '';
            loadDashboard(userEmail);
        } catch (error) {
            console.error('[Dashboard] Error adding site:', error);
            showError('Failed to add site: ' + error.message);
        }
    }
    
    // Remove a site
    async function removeSite(site) {
        if (!confirm(`Are you sure you want to remove ${site}? Billing will be updated automatically.`)) {
            return;
        }
        
        const member = await checkMemberstackSession();
        if (!member) {
            showError('Not authenticated');
            return;
        }
        
        const userEmail = member.email || member._email;
        
        try {
            const response = await fetch(`${API_BASE}/remove-site`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ 
                    site,
                    email: userEmail 
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to remove site');
            }
            
            showSuccess('Site removed successfully! Billing updated.');
            loadDashboard(userEmail);
        } catch (error) {
            console.error('[Dashboard] Error removing site:', error);
            showError('Failed to remove site: ' + error.message);
        }
    }
    
    // Load licenses
    async function loadLicenses(userEmail, memberstack) {
        const licensesContainer = document.getElementById('licenses-container');
        if (!licensesContainer) {
            console.error('[Dashboard] Licenses container not found');
            return;
        }
        
        licensesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading licenses...</div>';
        
        try {
            // Try email-based endpoint first
            let response = await fetch(`${API_BASE}/licenses?email=${encodeURIComponent(userEmail)}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            
            // If email endpoint doesn't work, try with session cookie
            if (!response.ok && response.status === 401) {
                response = await fetch(`${API_BASE}/licenses`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
            }
            
            if (!response.ok) {
                throw new Error('Failed to load licenses');
            }
            
            const data = await response.json();
            displayLicenses(data.licenses || []);
        } catch (error) {
            console.error('[Dashboard] Error loading licenses:', error);
            licensesContainer.innerHTML = '<div style="color: #f44336; padding: 20px;">Failed to load licenses</div>';
        }
    }
    
    // Display licenses
    function displayLicenses(licenses) {
        const container = document.getElementById('licenses-container');
        if (!container) return;
        
        if (licenses.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999;">
                    <p>No license keys yet. Licenses will appear here after payment.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = licenses.map(license => `
            <div class="license-item" style="
                background: #f5f5f5;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <div>
                    <div class="license-key" style="
                        font-family: 'Courier New', monospace;
                        font-size: 14px;
                        color: #333;
                        font-weight: bold;
                    ">${license.license_key}</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        Status: ${license.status} | 
                        Created: ${new Date(license.created_at * 1000).toLocaleDateString()}
                    </div>
                </div>
                <button class="copy-license-button" data-key="${license.license_key}" style="
                    background: #667eea;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                ">Copy</button>
            </div>
        `).join('');
        
        // Attach event listeners to copy buttons
        container.querySelectorAll('.copy-license-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const key = btn.getAttribute('data-key');
                copyLicense(key);
            });
        });
    }
    
    // Copy license key
    function copyLicense(key) {
        navigator.clipboard.writeText(key).then(() => {
            showSuccess('License key copied to clipboard!');
        }).catch(err => {
            showError('Failed to copy license key');
        });
    }
    
    // Logout function
    async function logout() {
        try {
            const memberstack = await waitForSDK();
            if (memberstack && memberstack.logout) {
                await memberstack.logout();
            }
            
            // Redirect to login page
            window.location.href = '/';
        } catch (error) {
            console.error('[Dashboard] Logout error:', error);
            // Still redirect even if logout fails
            window.location.href = '/';
        }
    }
    
    // Initialize dashboard
    async function initializeDashboard() {
        
        // Check if Memberstack SDK is available
        const scriptTag = document.querySelector('script[data-memberstack-app]');
        if (!scriptTag) {
            console.error('[Dashboard] ‚ùå Memberstack script tag not found!');
            showError('Authentication system not configured. Please add Memberstack SDK.');
            toggleDashboardVisibility(false);
            return;
        }
        
        // Wait for SDK and check session
        const member = await checkMemberstackSession();
        
        if (!member) {
            toggleDashboardVisibility(false);
            
            // Optionally redirect to login
            // window.location.href = '/?redirect=' + encodeURIComponent(window.location.pathname);
            return;
        }
        
        // User is logged in
        toggleDashboardVisibility(true);
        
        const userEmail = member.email || member._email;
        const memberstack = getMemberstackSDK();
        
        // Load dashboard data
        await Promise.all([
            loadDashboard(userEmail, memberstack),
            loadLicenses(userEmail, memberstack)
        ]);
        
        // Attach event listeners
        const addSiteButton = document.getElementById('add-site-button');
        if (addSiteButton) {
            addSiteButton.addEventListener('click', () => addSite(userEmail));
        }
        
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', logout);
        }
        
        // Allow Enter key in add site form
        const siteInput = document.getElementById('new-site-input');
        const priceInput = document.getElementById('new-site-price');
        if (siteInput && priceInput) {
            [siteInput, priceInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addSiteButton.click();
                    }
                });
            });
        }
        
    }
    
    // Initialize when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    } else {
        initializeDashboard();
    }
})();
</script>

<!-- Optional: Add login prompt for non-logged-in users -->
<div id="login-prompt" style="display: none; text-align: center; padding: 100px 20px; max-width: 500px; margin: 0 auto;">
    <div style="font-size: 48px; margin-bottom: 20px;">üîê</div>
    <h2 style="margin-bottom: 15px; color: #333;">Please Log In</h2>
    <p style="color: #666; margin-bottom: 30px;">You need to be logged in to view your dashboard.</p>
    <a href="/" style="
        display: inline-block;
        padding: 12px 24px;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
    ">Go to Login Page</a>
</div>

