<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Payment Successful - Redirecting to Login</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .success-container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .magic-link-box {
            background: #f5f5f5;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 30px 0;
            word-break: break-all;
        }

        .magic-link {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #667eea;
            margin-bottom: 15px;
            display: block;
            text-decoration: none;
            word-break: break-all;
        }

        .magic-link:hover {
            text-decoration: underline;
        }

        .btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .loading {
            color: #666;
            margin: 20px 0;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-size: 14px;
        }

        .instructions {
            text-align: left;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 6px;
            margin-top: 30px;
        }

        .instructions h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #666;
        }

        .instructions li {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="success-container">
        <div class="success-icon">✅</div>
        <h1>Payment Successful!</h1>
        <p class="subtitle">Your subscription has been activated</p>

        <div id="loading" class="loading">
            Payment confirmed! Checking email status...
        </div>

        <div id="error-message" class="error" style="display: none;"></div>

        <!-- Magic link section removed - links are only sent via email, never displayed on website -->
    </div>

    <!-- Memberstack SDK NOT needed here - Webflow login page has it -->
    <!-- User will be redirected to Webflow login page where Memberstack SDK handles passwordless -->
    <script>
        const API_BASE = 'https://consentbit-dashboard-test.web-8fb.workers.dev';

        // Get parameters from URL (Stripe Payment Links don't support email placeholder)
        function getParamsFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                email: urlParams.get('email') || urlParams.get('customer_email'),
                session_id: urlParams.get('session_id'),
                customer_id: urlParams.get('customer_id')
            };
        }

        // Show error
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Load payment confirmation - NO MAGIC LINK IS EVER DISPLAYED
        async function loadMagicLink() {
            const params = getParamsFromURL();
            
            // Build query string - PRIORITIZE session_id (most reliable), then customer_id, then email
            // session_id is most reliable because it fetches directly from Stripe
            let queryString = '';
            if (params.session_id) {
                queryString = `?session_id=${encodeURIComponent(params.session_id)}`;
            } else if (params.customer_id) {
                queryString = `?customer_id=${encodeURIComponent(params.customer_id)}`;
            } else if (params.email) {
                queryString = `?email=${encodeURIComponent(params.email)}`;
            }

            // Try to get email confirmation from API (NO MAGIC LINK RETURNED)
            try {
                // Add cache-busting parameter properly to existing query string
                const separator = queryString ? '&' : '?';
                const response = await fetch(`${API_BASE}/get-magic-link${queryString}${separator}_=${Date.now()}`);
                
                if (!response.ok) {
                    console.error('[success.html] API error:', response.status, response.statusText);
                    throw new Error(`API returned ${response.status}`);
                }
                
                const data = await response.json();

                // PRIORITY: Use email from API response (most reliable - comes from Stripe)
                // Only fall back to URL params if API doesn't return email (shouldn't happen)
                const email = data.email || 'your email';
                const emailDisplay = email !== 'your email' ? `<strong>${email}</strong>` : 'your email';
                
                // Log if email is missing
                if (!data.email) {
                    console.warn('[success.html] No email in API response. Data:', data);
                }
                
                // Redirect to Webflow login page where login page will create and send magic link
                // Login page will automatically create magic link and trigger Memberstack passwordless
                if (email && email !== 'your email') {
                    
                    // Webflow login page URL - Login page will create magic link and trigger passwordless
                    const webflowLoginUrl = 'https://memberstack-login-test-713fa5.webflow.io/';
                    const redirectUrl = `${webflowLoginUrl}?email=${encodeURIComponent(email)}`;
                    
                    // Show redirect message briefly, then redirect
                    document.getElementById('loading').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 20px;">✅</div>
                            <h2 style="color: #4caf50; margin-bottom: 10px;">Payment Successful!</h2>
                            <h3 style="color: #666; margin-bottom: 10px; font-size: 18px;">Your subscription has been activated</h3>
                            <p style="font-size: 16px; color: #666; margin-bottom: 20px;">Redirecting to login page...</p>
                            <p style="color: #999; font-size: 14px; margin-top: 20px;">You will receive a magic link email shortly.</p>
                        </div>
                    `;
                    
                    // Redirect IMMEDIATELY - no delay to prevent cached content
                    // Use replace instead of href to prevent back button issues
                    // Redirect immediately - don't wait
                    window.location.replace(redirectUrl);
                    
                    // CRITICAL: Return early to prevent showing old message
                    return;
                } else {
                    console.warn('[success.html] ⚠️ No email available - cannot redirect to login page');
                    showError('Unable to retrieve email. Please contact support.');
                    return;
                }

            } catch (error) {
                console.error('Error loading payment confirmation:', error);
                // Try to get email from URL params as fallback for redirect
                const urlParams = new URLSearchParams(window.location.search);
                const emailFromUrl = urlParams.get('email');
                
                // If we have email from URL, try to redirect anyway
                if (emailFromUrl) {
                    const webflowLoginUrl = 'https://memberstack-login-test-713fa5.webflow.io';
                    const redirectUrl = `${webflowLoginUrl}`;
                    
                    document.getElementById('loading').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 20px;">✅</div>
                            <h2 style="color: #4caf50; margin-bottom: 10px;">Payment Successful!</h2>
                            <h3 style="color: #666; margin-bottom: 10px; font-size: 18px;">Your subscription has been activated</h3>
                            <p style="font-size: 16px; color: #666; margin-bottom: 20px;">Redirecting to login page...</p>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1500);
                    return;
                }
                
                // If no email available, show generic success message
                document.getElementById('loading').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">✅</div>
                        <h2 style="color: #4caf50; margin-bottom: 10px;">Payment Successful!</h2>
                        <h3 style="color: #666; margin-bottom: 10px; font-size: 18px;">Your subscription has been activated</h3>
                        <p style="font-size: 16px; color: #666; margin-bottom: 20px;">
                            Please visit the login page to access your account.
                        </p>
                        <a href="https://memberstack-login-test-713fa5.webflow.io/" style="
                            display: inline-block;
                            padding: 12px 24px;
                            background: #2196F3;
                            color: white;
                            text-decoration: none;
                            border-radius: 6px;
                            font-weight: 600;
                            margin-top: 20px;
                        ">Go to Login Page</a>
                    </div>
                `;
            }
        }

        // copyMagicLink function removed - magic links are never displayed on the website

        // Auto-load payment confirmation on page load
        // VERSION: 2025-01-19 - Redirects immediately to login page
        
        // Start loading immediately - no delay
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadMagicLink);
        } else {
            loadMagicLink(); // DOM already loaded
        }
    </script>
</body>
</html>
